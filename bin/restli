#!/bin/sh

GIT_SKELETON="git://gitli.corp.linkedin.com/restli-skeleton/restli-skeleton.git"
SBT_LAUNCHER_PATH="bin/sbt/sbt-launch.jar"
G8_LAUNCH_CONFIG_PATH="bin/g8/giter8.launchconfig"
SKELETON_PROPERTIES_PATH="src/main/g8/default.properties"

skeleton=$GIT_SKELETON

err() {
  echo "$@" >&2
}

help () {
  name=`basename $0`
  err "Usage : $name <command>" 
  err "Available commands:"
  echo "   new [skeleton file path or git-url] - Generate a new rest.li project skeleton.\n"
}

dir=`dirname $0`
parent=$(cd $dir/..; pwd)
if [ -r $parent/$SKELETON_PROPERTIES_PATH ]; then
  echo "[This appears to be local development checkout.  Using $parent for RESTLI_HOME and skeleton]"
  RESTLI_HOME=$parent
  skeleton="file://$parent"
fi

if [ -z "$RESTLI_HOME" ]; then
  err "RESTLI_HOME is not set.  It must be set to the root of the restli install."
  exit 1
fi

sbt_launcher=$RESTLI_HOME/$SBT_LAUNCHER_PATH
g8_launch_config=$RESTLI_HOME/$G8_LAUNCH_CONFIG_PATH

if [ ! -r $sbt_launcher ] || [ ! -r $g8_launch_config ]; then
  err "RESTLI_HOME is not set to a valid path.  It must be set to the root of the restli install."
  exit 1
fi

if [ -z "$JAVA_HOME" ]; then
  JAVA="java"
else
  JAVA="$JAVA_HOME/bin/java"
fi

if [ $# -lt 1 ]; then
  help
  exit 1
fi

COMMAND="$1"
case $COMMAND in
"new") 
   if [ $# -ge 2 ]; then
     skeleton=$2
   fi
   "$JAVA" -Xmx512M -jar $sbt_launcher @$g8_launch_config $skeleton
   ;;
*) 
   err "Unrecognized command: $COMMAND\n"
   help
   ;;
esac
